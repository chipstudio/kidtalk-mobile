<guessing-game definition>

	<template>
        <div id="trophy-icon" onclick="" show="true">
            <svg width="30pt" height="30pt" version="1.1" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <g>
                <path xmlns="http://www.w3.org/2000/svg" d="M23.36,57.51H41.806a1,1,0,0,0,1-1V47.542a1,1,0,0,0-1-1H23.36a1,1,0,0,0-1,1V56.51A1,1,0,0,0,23.36,57.51Zm1-8.968H40.806V55.51H24.36ZM50.914,6.083H44.9V3.49a1,1,0,0,0-1-1H21.271a1,1,0,0,0-1,1V6.083h-6.02a3,3,0,0,0-3,3v6.283a3.022,3.022,0,0,0,1.43,2.556l9.6,5.9a12.042,12.042,0,0,0,6.6,4.869v4.687a6.76,6.76,0,0,1-2.334,5.114h-.968a5.005,5.005,0,0,0-4.9,4.052H19.36a1,1,0,0,0-1,1V60.51a1,1,0,0,0,1,1H45.806a1,1,0,0,0,1-1V43.542a1,1,0,0,0-1-1H44.493a5,5,0,0,0-4.9-4.052h-.968a6.757,6.757,0,0,1-2.334-5.114V28.689a12.045,12.045,0,0,0,6.6-4.869l9.6-5.9a3.02,3.02,0,0,0,1.429-2.555V9.083A3,3,0,0,0,50.914,6.083Zm-6.019,5h4.019v3.165L44.9,16.717Zm-2-6.593V6.083H22.271V4.49ZM16.251,14.248V11.083h4.02v5.634Zm-2.522,1.97a.994.994,0,0,1-.478-.852V9.083a1,1,0,0,1,1-1h6.02v1h-5.02a1,1,0,0,0-1,1v4.724a1,1,0,0,0,.477.852l5.722,3.515a11.842,11.842,0,0,0,.306,1.362ZM44.806,59.51H20.36V44.542H44.806ZM42.413,42.542H22.745a3,3,0,0,1,2.832-2.052H39.589A2.983,2.983,0,0,1,42.413,42.542Zm-9.83-4.052H29.228a8.512,8.512,0,0,0,1.651-5.114V33h3.408v.376a8.512,8.512,0,0,0,1.651,5.114Zm1.7-7.49H30.879V29.1a12.068,12.068,0,0,0,1.392.088H32.9a12.082,12.082,0,0,0,1.392-.088ZM32.9,27.185h-.624a10.011,10.011,0,0,1-10-10v-9.1H42.9v9.1A10.011,10.011,0,0,1,32.9,27.185ZM51.914,15.366a1,1,0,0,1-.476.852L44.41,20.536a12.056,12.056,0,0,0,.306-1.362l5.722-3.515a1,1,0,0,0,.476-.852V10.083a1,1,0,0,0-1-1H44.9v-1h6.019a1,1,0,0,1,1,1ZM20.562,35.136a1,1,0,0,0,0-2c-.078,0-.154,0-.231,0-2.976-.069-3.476-3-3.524-3.334a1,1,0,0,0-1.983,0c-.018.136-.464,3.263-3.525,3.334-.075,0-.153,0-.23,0a1,1,0,0,0,0,2c.079,0,.156,0,.232,0,2.975.069,3.476,3,3.524,3.334a1,1,0,0,0,.987.867h0a1,1,0,0,0,.99-.863c.049-.34.549-3.269,3.525-3.338C20.406,35.138,20.482,35.137,20.562,35.136Zm-4.748.46a5.547,5.547,0,0,0-1.369-1.46,5.544,5.544,0,0,0,1.369-1.459,5.566,5.566,0,0,0,1.37,1.459A5.6,5.6,0,0,0,15.814,35.6Zm37.012-8.411c-.063,0-.125,0-.188,0a2.825,2.825,0,0,1-2.658-2.526,1,1,0,0,0-.986-.866h-.006a1,1,0,0,0-.99.86,2.828,2.828,0,0,1-2.66,2.532c-.062,0-.124,0-.188,0a1,1,0,0,0,0,2c.063,0,.125,0,.188,0A2.827,2.827,0,0,1,48,31.711a1,1,0,0,0,.986.867h.006a1,1,0,0,0,.99-.861,2.826,2.826,0,0,1,2.659-2.532c.062,0,.126,0,.189,0a1,1,0,0,0,0-2Zm-3.838,1.841a4.662,4.662,0,0,0-.79-.841,4.7,4.7,0,0,0,.79-.841,4.662,4.662,0,0,0,.79.841A4.662,4.662,0,0,0,48.988,29.026ZM37.725,14.056,34.8,13.62l-1.3-2.66a1,1,0,0,0-.9-.561h0a1,1,0,0,0-.895.555l-1.32,2.65-2.933.416a1,1,0,0,0-.56,1.7L29,17.8l-.51,2.918a1,1,0,0,0,1.447,1.059l2.626-1.369,2.617,1.387a1,1,0,0,0,1.454-1.049l-.49-2.92,2.127-2.06a1,1,0,0,0-.547-1.708Zm-3.349,2.7a1,1,0,0,0-.291.884l.242,1.441-1.291-.684a1,1,0,0,0-.931,0l-1.295.675.252-1.44a1,1,0,0,0-.284-.886l-1.043-1.023,1.447-.205a1,1,0,0,0,.755-.544l.651-1.308.641,1.312a1,1,0,0,0,.751.55l1.446.215Zm5.2,36.273a1,1,0,0,1-1,1h-.294a1,1,0,0,1,0-2h.294A1,1,0,0,1,39.577,53.025Zm-3,0a1,1,0,0,1-1,1h-2a1,1,0,0,1,0-2h2A1,1,0,0,1,36.58,53.025Z"/></g>
            </svg>
        </div>
        <div id="x-icon" onclick="" show="true">
            <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" height="30px" width="30px" fill="#000000" version="1.1" x="0px" y="0px" viewBox="0 0 32 32" style="enable-background:new 0 0 32 32;" xml:space="preserve"><g><g><path d="M10,23c-0.2558594,0-0.5117188-0.0976563-0.7070313-0.2929688c-0.390625-0.390625-0.390625-1.0234375,0-1.4140625l12-12    c0.390625-0.390625,1.0234375-0.390625,1.4140625,0s0.390625,1.0234375,0,1.4140625l-12,12    C10.5117188,22.9023438,10.2558594,23,10,23z"/></g><g><path d="M22,23c-0.2558594,0-0.5117188-0.0976563-0.7070313-0.2929688l-12-12c-0.390625-0.390625-0.390625-1.0234375,0-1.4140625    s1.0234375-0.390625,1.4140625,0l12,12c0.390625,0.390625,0.390625,1.0234375,0,1.4140625    C22.5117188,22.9023438,22.2558594,23,22,23z"/></g></g></svg>
            <span id="counter">0</span>
        </div>
        <div class="guess-wrapper">
            <!-- <div class="guess-img">
                <div class="mario">
                    <div class="box">
                        <span class="coin">
                            <img src="/assets/coin3.png">
                        </span>
                    </div>
                </div>
            </div> -->

            <img src="/images/Animations/GuessTheWord1.gif" class="guess-icon">

            <div class="text">
                Play the following clip and guess what is being said!
            </div>
            <div class="recording" id="guess-recording" mode="paused">
                <audio id="player2" controls ontimeupdate="" style="display:none"></audio>

                <div id="playback_button" class="record media-button" onclick="trigger_play()">
                    <play-icon></play-icon>
                </div>
                <div id="stop_button" class="pause media-button" onclick="trigger_stop()">
                    <pause-icon></pause-icon>
                </div>

            </div>
            <div class="translation">
                <div class="title">
                    Transcription
                </div>
                <div class="transcription-text">
                    <textarea id="guess_input" spellcheck="false" autocapitalize="off" autocorrect="off"></textarea>
                    <br>
                    <button onclick="submit()">Submit Guess</button>
                </div>
            </div>
            </canvas>
        </div>
        <div class="answer-wrapper">
            <div class="correct-answer">

            </div>
            <div class="incorrect-answer">
            </div>
        </div>
	</template>

	<style>
        .guess-wrapper {
            /* padding-top: 40px; */
            text-align: center;
            margin: 0 auto;
            font-family: 'proxima-soft', sans-serif;
        }
        .guess-wrapper .guess-img {

        }
        .guess-wrapper .text {
            display:block;
            max-width: 300px;
            margin: 0 auto;
            /* margin-bottom: 0; */
            font-size:1.8rem;
            font-weight:700;
            text-align:center;
            padding: 40px 10px 30px 10px;
            color: #000;
        }

        .recording {
            margin-top:20px;
        }

        .guess-wrapper .recording img {
            border: 2px solid #f2f2f2;
            border-radius: 5px;
        }


        .translation {
            margin:0 auto;
            max-width:320px;
        }

        .guess-wrapper .translation .title {
            /* padding-top: 40px; */
            /* padding-bottom: 20px; */
            padding: 20px 0;
            margin: 0 auto;
            margin-top:20px;
            font-size: 1.8rem;
            font-weight: 700;

        }
        .guess-wrapper .translation .transcription-text textarea{
            border: 2px solid #FF7648;
            resize: none;
            height: 100px;
            font-size: 18px;
            padding: 15px;
            border-radius:20px;
            margin: 0 auto 0 auto;
            box-sizing: border-box;
            text-align:left;
            width:100%;
        }

        .guess-wrapper .translation .transcription-text button {
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.4px;

            box-sizing: border-box;
            border: none;
            cursor:pointer;
            background-color: #FF7648;
            margin-top: 20px;
            padding:18px 32px;
            border-radius: 20px;
            font-size:1.6em;
            font-family: 'proxima-soft', sans-serif;
            color: white;
            width:100%;
        }

        div.guess-wrapper[answer='false'] {
            animation: shake 0.5s;
            animation-iteration-count: 2;
        }

        .guess-icon {
            display:block;
            height:auto;
            margin:0 auto;
            width:120px;
        }

        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        .guess-wrapper div.mario {
            display:table;
            position:relative;
            margin:50px auto 0 auto;
        }

        .guess-wrapper div.mario span.coin{
            position:absolute;
            width:100%;
            text-align:center;
            margin-top:0px;
            opacity:0;
            left: 0px;
        }

        .guess-wrapper div.mario div.box{
            position:relative;
            width:100px;
            height:100px;
            z-index:1;
            transition:margin-top .2s;
            cursor:pointer;
            background-image:url("/images/SVG/buttons/KidTalk_Guess_The_Word.svg");
            background-size:contain;
            /*background-position:0 0;*/
        }

        .guess-wrapper div.mario div.box.empty{
            background-image:url("/images/SVG/buttons/KidTalk_Guess_The_Word.svg");
            background-size:contain;
            /* background-position:100px 0; */
            margin-top:0;
            cursor:not-allowed;
        }

        .guess-wrapper div.mario span.coin img{
            transition:opacity .3s ease-out;
        }

        .guess-wrapper div.mario span.coin.play{
            transition:all .5s ease-out;
            -webkit-animation-name: position;
            -webkit-animation-duration: 800ms;
            -webkit-animation-timing-function: linear;
            -moz-animation-name: position;
            -moz-animation-duration: 800ms;
            -moz-animation-timing-function: linear;
            -ms-animation-name: position;
            -ms-animation-duration: 800ms;
            -ms-animation-timing-function: linear;
            animation-name: position;
            animation-duration: 800ms;
            animation-timing-function: linear;
        }

        .guess-wrapper div.mario span.coin.play img{
            -webkit-animation-name: spin;
            -webkit-animation-duration: 400ms;
            -webkit-animation-iteration-count: infinite;
            -webkit-animation-timing-function: linear;
            -moz-animation-name: spin;
            -moz-animation-duration: 400ms;
            -moz-animation-iteration-count: infinite;
            -moz-animation-timing-function: linear;
            -ms-animation-name: spin;
            -ms-animation-duration: 400ms;
            -ms-animation-iteration-count: infinite;
            -ms-animation-timing-function: linear;
            animation-name: spin;
            animation-duration: 400ms;
            animation-iteration-count: infinite;
            animation-timing-function: linear;
        }

        @-moz-keyframes spin {
            10% { width:60px;width:80px}
            45% { width:3px;width:80px}
            90% { width:60px;width:80px;}
        }
        @-webkit-keyframes spin {
            10% { width:60px;width:80px}
            45% { width:3px;width:80px}
            90% { width:60px;width:80px;}
        }
        @keyframes spin {
            10% { width:60px;width:80px}
            45% { width:3px;width:80px}
            90% { width:60px;width:80px;}
        }

        @-moz-keyframes position {
            10% { margin-top:-100px;opacity:0;}
            25% { margin-top:-130px;opacity:1;}
            85% { margin-top:-180px;}
            90% { margin-top:-200px;opacity:0;}
        }
        @-webkit-keyframes position {
            10% { margin-top:-100px;opacity:0;}
            25% { margin-top:-130px;opacity:1;}
            85% { margin-top:-180px;}
            90% { margin-top:-200px;opacity:0;}
        }
        @keyframes position {
            10% { margin-top:-100px;opacity:0;}
            25% { margin-top:-130px;opacity:1;}
            85% { margin-top:-180px;}
            90% { margin-top:-200px;opacity:0;}
        }

        #media[mode='pending'] #playback_button,
        #media[mode='playing'] #pause_button,
        #media[mode='paused'] #playback_button {
            display:inline-block;
        }

        #playback_button[enabled="true"] {
            opacity:1;
        }

        #playback_button[enabled="false"] {
            opacity:.5;
        }
        
        .guess-wrapper .media-button {
            display: inline-block;
            cursor:pointer;
        }
        
        .guess-wrapper .media-button svg {
            padding-top: 0;
        }

        #trophy-icon {
            position: absolute;
            top: 15px;
            right: 63px;
            z-index: 3;
            height: 30px;
            width: 30px;
        }

        #x-icon {
            position: absolute;
            top: 15px;
            right: 8px;
            z-index: 3;
            height: 30px;
            width: 60px;
        }

        #x-icon svg {
            vertical-align: middle;
        }

        #counter {
            font-weight: 900;
            font-family: 'proxima-soft', sans-serif;
            font-size: 20px;
            vertical-align: middle;
        }

        #guess-recording {
            text-align:center;
        }

        #guess-recording[mode="playing"] .record {
            display:none;
        }

        #guess-recording[mode="playing"] .pause {
            display:inline-block;
        }

        #guess-recording[mode="paused"] .record {
            display:inline-block;
        }

        #guess-recording[mode="paused"] .pause {
            display:none;
        }

        .incorrect:before,
        .correct:before {
            background-image:url("/images/Animations/GuessTheWord3.gif");
            content:'';
            background-repeat:no-repeat;
            background-size:contain;
            background-position:center;
            display:block;
            height:70px;
            margin:0 auto;
            margin-bottom:20px;
            width:100px;
        }

        .incorrect,
        .correct {
            color:#BE1E2C;
            font-size:2rem;
            font-weight:700;
            padding-bottom:50px;
            text-align:center;
        }

        .correct:before {
            background-image:url("/images/Animations/GuessTheWord2.gif");
        }

        .correct {
            color:#29AC5F;
        }
	</style>

	<script>
        var counter = 0;
        var regex = /[!"#$%&'()*+,-./:;<=>?@[\]^_`{|}~]/g;
        var recording_subscription = null
        var verified_subscription = null
        function load_recordings () {
            doc.clear_class_attr("guess-wrapper", "answer")
            doc.get_id("playback_button").setAttribute("enabled", false)
            data.unsubscribe(recording_subscription)
            data.unsubscribe(verified_subscription)

            var verified_user_ids = []
            verified_subscription = data.subscribe_collection("User", {
                query: function (query) {
                    return query.where("verified", "==", true)
                },
                update: function (verified_users) {
                    var i = 0

                    verified_users.forEach(function (verified_user) {
                        verified_user_ids.push(verified_user.id)
                    })

                    recording_subscription = data.subscribe_collection("Recording", {
                        query: function (query) {
                            return query.where("private", "==", false).where("file_time", ">=", 1591232628186)
                        },
                        update: function (recordings) {
                            window.player2 = doc.get_id("player2")
                            var short_recordings = []
                            recordings.forEach(function(recording){
                                recording.duration = parseFloat(recording.duration)
                                if (recording.duration > 0 && recording.duration < 10 && recording.hasOwnProperty("audio_file") && verified_user_ids.indexOf(recording.user_id) > -1) {
                                    short_recordings.push(recording)
                                }
                            })

                            var length = Number(short_recordings.length)
                            var recording_index = Math.floor(Math.random() * length)
                            if (short_recordings.length > 0) {
                                load_recording_url(short_recordings[recording_index].id).then(function(response) {
                                    doc.get_id("playback_button").setAttribute("enabled", true)
                                    window.player2src = response[0];
                                    window.correct_transcription = short_recordings[recording_index].transcription.replace(regex, '').toLowerCase()
                                    window.player2.src = window.player2src
                                    window.clip_id = short_recordings[recording_index].id;

                                    window.player2.addEventListener('ended', function (e) {
                                        doc.get_id("guess-recording").setAttribute("mode", "paused")
                                    })
                                })
                            }
                        }
                    })
                }
            })
        }

        function load_recording_url (recording_id) {
            return new Promise(function (resolve, reject) {
                var get_recording_url_mobile = firebase.functions().httpsCallable('get_recording_url_mobile');
                get_recording_url_mobile({recording_id: recording_id}).then(function(result) {
                    resolve([result.data.url]);
                }).catch((error) => {
                    console.log("file: guessing-game.html -> line 449 -> error", error);
                    reject();
                });
            })
        }
        
        function trigger_play() {
            if (doc.get_id("playback_button").getAttribute("enabled") == "false") {
                return
            }

            window.player2.onerror = function () {
                load_recordings()
                doc.get_id("guess-recording").setAttribute("mode", "paused")
            }

            window.player2.src = window.player2src
            window.player2.play()
            doc.get_id("guess-recording").setAttribute("mode", "playing")
        }
        function trigger_stop() {
            // window.player2.src = window.player2src
            window.player2.pause()
            doc.get_id("guess-recording").setAttribute("mode", "paused")
        }
        
        function submit() {
            trigger_stop();
            var user_answer = doc.get_id("guess_input").value.replace(regex, '').toLowerCase()
            var answer = window.correct_transcription
            data.create_model("Guess", {
                recording_id: window.clip_id,
                guessed_transcription: doc.get_id("guess_input").value,
                date: firebase.firestore.FieldValue.serverTimestamp(),
                user_id: window.user_id,
                actual_transcription: window.correct_transcription,
                correct: (user_answer == answer)
            })

            db.collection("Recording")
                .doc(window.clip_id)
                .get()
                .then((docRef) => { 

                    if(answer != user_answer) {
                        doc.get_class('guess-wrapper')[0].setAttribute("answer", false)
                        doc.get_id("guess_input").value = answer
                        var incorrect_el = doc.create_el("div", {
                            className: "incorrect",
                            innerHTML: '" ' + answer + ' "'
                        })
                        doc.render_modal(incorrect_el.outerHTML)
                    } else {
                        var correct_el = doc.create_el("div", {
                            className: "correct",
                            innerHTML: '" ' + answer + ' "'
                        })
                        doc.render_modal(correct_el.outerHTML)
                    }

                    load_recordings() 
                    doc.get_id("guess_input").value = ""

                    setTimeout(function(){ 
                        doc.close_modal()

                    }, 3000);
                })
                .catch((error) => { })
        }
	</script>
</kidtalk-logo>